Patmos LLVM
================

This is a fork of the LLVM Project that adds a target for the Patmos Architecture.

# Development

### Requirements

Platform:

- Ubuntu 18/20
- MacOs
- Windows Subsystem for Linux running Ubuntu 18/20

Tools:

- `gcc` v9.1 or `clang` v11.0.0
- `git` v2.17.1
- `cmake` v4.0.0
- Patmos Simulator Tools v1.0.2

### Branches

- `master`: Primary development branch.
- `upstream`: Only for tracking the upstream LLVM repository. Should only be used to pull in new versions of LLVM and not to make any changes to them. [See more here](#anch-updating-llvm).

### Cloning

The LLVM project is very large so we can save some time by avoiding cloning the part we don't use for Patmos.
The following commands with clone only the parts of the Patmos LLVM repository that we actually use:

```
git clone --filter=blob:none --sparse git@github.com:t-crest/patmos-llvm-project
cd patmos-llvm-project
git sparse-checkout add /.github /llvm /clang
```

### Build

Ensure all the above reqruirements are met and that the tools are available on the PATH.

Then you must create a build folder.
This folder doesn't have to be in the LLVM Project root folder, but that is where we will put it in this example.
In this folder, you must setup the build with `cmake` (referencing the LLVM subfolder), after which you can build:

```
mkdir -p build
cd build
cmake ../llvm -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR -DLLVM_TARGETS_TO_BUILD=Patmos -DLLVM_DEFAULT_TARGET_TRIPLE=patmos-unknown-unknown-elf -DLLVM_ENABLE_PROJECTS="clang" -DCLANG_ENABLE_ARCMT=false -DCLANG_ENABLE_STATIC_ANALYZER=false -DCLANG_BUILD_EXAMPLES=false -DLLVM_ENABLE_BINDINGS=false -DLLVM_INSTALL_BINUTILS_SYMLINKS=false -DLLVM_INSTALL_CCTOOLS_SYMLINKS=false -DLLVM_INCLUDE_EXAMPLES=false -DLLVM_INCLUDE_BENCHMARKS=false -DLLVM_APPEND_VC_REV=false -DLLVM_ENABLE_WARNINGS=false -DLLVM_ENABLE_PEDANTIC=false -DLLVM_ENABLE_LIBPFM=false -DLLVM_BUILD_INSTRUMENTED_COVERAGE=false -DLLVM_INSTALL_UTILS=false
make -j
```
Where the $INSTALL_DIR should be the local installation folder. typically '../local'.

### Test

To run the tests you must first build following the previous section.
Then it is simple enough. From the build folder a single command can be used:

```
make check-all
```

### <a name="anch-updating-llvm"></a>Updating LLVM

Even though this repository is a fork of [the official LLVM repository](https://github.com/llvm/llvm-project), 
we only pull the upstream changes at official release tags.
The `upstream` branch is specifically intended for this and nothing else.
Its `HEAD` should always be a commit for an official release.
E.g. it could be tracking the commit for the 11.1.0 release.

Updating to a new release of upstream LLVM is not a trivial task.
The main difficulty comes from the fact that LLVM uses release branches, whic means their history splits after a major release. 
This means trying to simply pull in the latest release tag will likely cause many merge conflicts in LLVM code that we (the Patmos project) haven't touched.
Trying to fix the merge conflict can be tedious and error prone.
Instead, the following guide will mimick mergin by simply applying Patmos' code directly to the new release.
This will cause much fewer and simply conflicts and is much less likely to be done incorrectly:

_`llvm-upstream` refers to the LLVM github repo: github.com/llvm/llvm-project._

_`t-crest` refers to the Patmos LLVM github repo: github.com/t-crest/patmos-llvm-project._

_As an example, `llvmorg-11.1.0` is the current LLVM version tag used by Patmos, and `llvmorg-12.0.1` is the one we are trying to update to. Change them as appropriate_

* Get the most recent LLVM release's tag: 
```sh
git checkout master
git pull llvm-upstream --tags
```

* Update the `upstream` branch to point to it: 
```sh
git branch -f upstream llvmorg-12.0.1
```

* Push the new tag and "upstream" to the t-crest repo:
```sh
git checkout upstream
git push t-crest +upstream
git push llvmorg-12.0.1
```

* Create a diff of the difference between Patmos HEAD and `llvmorg-11.1.0`, which will then contain all Patmos-specific code/changes:
```sh
git diff llvmorg-11.1.0 master > patmos-diff.patch
```

* Move to a temporary branch where you apply the changes to the latest LLVM release:
```sh
git checkout llvmorg-12.0.1 -b tempbranch
git apply --reject --verbose --ignore-whitespace patmos-diff.patch
```

* Git has now applied all changes it can. Where unable, it left a `*.rej` file containing the unapplied patmos changes (where `*` is th name of the file containing the unapplied code).
Go through the project and apply rejected code manually and deleting the `*.rej` files as you go.
To check whether you applied the diff correctly, you can print out the changes (`git diff > post-apply-patmos-diff.patch`) and compare it with the original diff (`diff post-apply-patmos-diff.patch patmos-diff.patch`). 
The differences should be minor and only in non-patmos code.

* Commit: `git commit -m "Merged Patmos HEAD with llvmorg-12.0.1"`

* Rewrite git history, to show that the last Patmos commit is also a parent of the new one (to make it look like we merged it with `llvmorg-12.0.1`):
```sh
git replace --graft tempbranch llvmorg-12.0.1 master
git filter-branch llvmorg-12.0.1..tempbranch
```

* Change `master` to point to the new commit, delete the temporary branch, and push to T-CREST reposity:
```sh
git branch -f master tempbranch
git checkout master
git branch -D tempbranch
git push origin +master
```

You have now effectively merged the old Patmos head with the new LLVM release tag.
The git history will showing as being a merge of the two commits.
After this, the Patmos code will probably need tweaking to conform to any changes LLVM has made since the last release.














